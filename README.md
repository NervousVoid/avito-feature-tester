## Как протестировать работу удаления юзеров из сегментов по ранее заданному дедлайну
#### Это быстрый костыль, который я использую, потому что не успеваю написать нормальные тесты

1) Сначала как обычно создаем нужные сегменты
#### **POST** /api/create_segment
```json
{
  "segment_slug": "AVITO_TTL_TEST"
}
```
2) При добавлении пользователя в сегмент теперь есть новое поле **cur_time**, в котором нужно указать дату, которая подставится как текущая, в формате "2023-09-03"

#### **POST** /api/update_user_segments
```json
{
  "user_id": 1234,
  "assign_segments": ["AVITO_TTL_TEST"],
  "unassign_segments": [],
  "ttl": "2", //ttl указывается в днях
  "cur_time": "2023-09-03"
}
```
После этого, модуль, раз в минуту проверяющий наличие просроченных сегментов, будет думать, что сейчас 2023-09-03

Дальше тестируете как и раньше. Если хотите подставить новую дату, просто отправьте новый update_user_segments запрос с новой датой

#### Запуск
```shell
### Запуск
  docker-compose up
```
#### Запуск, если в прошлый раз что-то пошло не по плану
```shell
  docker rm $(docker ps -a -q) && docker volume prune -f
  docker rmi -f avito-segmentator
  docker-compose up
```

#### Остальные методы
#### **POST** /api/create_segment
Метод создания нового сегмента

Принимает *опцианальный* параметр **Fraction**, при задании которого, создаваемый сегмент будет автоматически присваиваться заданному проценту случайных пользователей

*В примере ниже сегмент 30-процентной скидки будет создан и автоматически присвоен 10% пользователей*

*Принимаемая структура*
```json
{
  "segment_slug": "AVITO_DISCOUNT_30",
  "fraction": 10
}
```
или, если нужно просто создать сегмент:
```json
{
  "segment_slug": "AVITO_DISCOUNT_30"
}
```

#### **DELETE** /api/delete_segment
Метод удаления сегмента

*Принимаемая структура*
```json
{
  "segment_slug": "AVITO_VOICE_MESSAGES"
}
```

#### **GET** /api/get_user_segments
Метод получения активных сегментов пользователя

*Принимаемая структура*
```json
{
  "user_id": 1002
}
```
*Возвращаемая структура*
```json
{
  "segments": ["AVITO_DISCOUNT_30","AVITO_DISCOUNT_50"],
  "user_id": 1002
}
```

#### **GET** /api/get_user_history
Метод получения активных сегментов пользователя
Принимает id пользователя, а также границы временного промежутка в форматах "YYYY-MM" или "YYYY-M"

Возвращает ссылку на отчет в формате .csv

*Принимаемая структура*
```json
{
  "user_id": 1000,
  "start_date": "2023-5",
  "end_date": "2023-9"
}
```
*Возвращаемая структура*
```json
{
  "csv_url": "0.0.0.0:8000/reports/report_k6cyy3f25a.csv"
}
```